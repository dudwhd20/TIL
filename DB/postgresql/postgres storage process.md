# PostgreSQL 데이터 저장 과정

PostgreSQL에서 데이터는 트랜잭션의 무결성과 데이터의 영속성을 보장하기 위해 철저히 관리됩니다. 이 문서에서는 PostgreSQL에서 데이터가 저장되는 전체 과정을 단계별로 설명합니다.

---

## 1. 클라이언트 요청

1. 클라이언트 애플리케이션이 SQL 명령(예: `INSERT`, `UPDATE`, `DELETE`)을 PostgreSQL 서버로 전송합니다.
2. PostgreSQL의 **Postmaster 프로세스**가 이 요청을 수신하고 처리할 준비를 합니다.

---

## 2. 세션 및 프로세스 생성

1. PostgreSQL은 클라이언트 요청을 처리하기 위해 **백엔드 프로세스(Backend Process)**를 생성합니다.
2. 각 세션은 독립적인 백엔드 프로세스에서 처리되며, 클라이언트와 서버 간의 통신을 담당합니다.

---

## 3. SQL 처리 과정

SQL 명령은 PostgreSQL 서버에서 다음 단계를 거칩니다:

### 3.1. 파싱 (Parsing)
- SQL 문법을 검사하고 **파싱 트리**를 생성합니다.
- 구문 분석을 통해 SQL 문이 유효한지 확인합니다.

### 3.2. 계획 (Planning)
- SQL 명령을 최적화하여 실행 계획을 생성합니다.
- PostgreSQL의 **쿼리 플래너(Query Planner)**가 효율적인 실행 경로를 선택합니다.

### 3.3. 실행 (Execution)
- 실행 계획에 따라 데이터를 검색하거나 변경합니다.
- 변경된 데이터는 PostgreSQL의 **메모리 버퍼(Shared Buffers)**와 **WAL(Write-Ahead Log)**에 기록됩니다.

---

## 4. 데이터 변경 사항 저장 과정

### 4.1. 공유 버퍼 (Shared Buffers)
- 데이터 변경 사항은 PostgreSQL의 **공유 버퍼**(메모리 영역)에 먼저 기록됩니다.
- 공유 버퍼는 데이터 변경 사항을 임시로 유지하며 디스크 쓰기를 최소화합니다.

### 4.2. WAL (Write-Ahead Logging)
- PostgreSQL은 데이터 무결성을 보장하기 위해 변경 사항을 **WAL**(Write-Ahead Log)에 기록합니다.
- WAL은 순차적으로 디스크에 쓰이므로 I/O 성능이 최적화됩니다.

#### WAL 기록 단계:
1. 변경 사항은 **WAL 버퍼**(메모리)에 기록됩니다.
2. 일정 시점마다 WAL 버퍼 내용이 디스크의 `pg_wal/` 디렉토리에 저장됩니다.

---

## 5. 디스크에 데이터 저장

### 5.1. 데이터 파일 쓰기
- PostgreSQL의 **백그라운드 작업자(Background Writer)**는 공유 버퍼의 내용을 주기적으로 디스크에 기록합니다.
- 데이터는 PostgreSQL 데이터 디렉토리(`base/`)의 파일로 저장됩니다.

### 5.2. 체크포인트 (Checkpoint)
- PostgreSQL은 주기적으로 **체크포인트**를 생성하여 변경된 데이터를 WAL에서 데이터 파일로 동기화합니다.
- 체크포인트는 복구 시 WAL의 크기를 줄이고 복구 속도를 높입니다.

---

## 6. 트랜잭션 처리

### 6.1. 트랜잭션 ID (TXID)
- PostgreSQL은 트랜잭션마다 고유한 트랜잭션 ID(TXID)를 생성하여 상태를 관리합니다.
- TXID는 테이블 내에 xmin, xmax가 포함되어 UPDATE, DELETE 문 처리시 MVCC에 활용 (Dead Tuples)
- 이러한 작업에 대한 로그는 CLOG에 작성 pg_xact/ 디렉터리에 있음
- 00 진행중
- 01 커밋됨
- 10 롤백됨
- 11 특별한상태? 라는데 뭔지 모르겠음

### 6.2. 커밋 (Commit)
- 트랜잭션이 완료되면 변경 사항이 WAL과 데이터 파일에 영구적으로 저장됩니다.
- `COMMIT`이 완료되기 전에는 변경 사항이 다른 세션에서 보이지 않습니다.

### 6.3. 롤백 (Rollback)
- 트랜잭션 중 오류가 발생하면 PostgreSQL은 **WAL**을 참조하여 변경 사항을 복구하고 원래 상태로 되돌립니다.

---

## 7. 데이터 복구

### 7.1. 장애 복구 (Crash Recovery)
- 서버가 비정상 종료되었을 경우, PostgreSQL은 WAL을 사용해 데이터 변경 사항을 재생(Replay)하여 데이터 무결성을 복구합니다.

### 7.2. 포인트 인 타임 복구 (Point-In-Time Recovery, PITR)
- WAL 로그를 활용하여 특정 시점으로 데이터베이스를 복구할 수 있습니다.
- WAL 아카이브 파일을 만드려면, wal_level 환경 설정 매개 변수의 값으로 replica 또는 그 이상으로 지정한다. 다음, archive_mode 환경 설정 매개 변수 값은 on
- 이 설정이 되어 있지않으면 PITR은 사용 불가
- pg_wal/ 디레터리에 작성

---

## 8. 데이터 저장 구조

### 8.1. 데이터 디렉토리 구조
- PostgreSQL 데이터는 디스크의 **데이터 디렉토리**에 파일 형태로 저장됩니다:
  - `base/`: 데이터베이스별 데이터 파일.
  - `pg_wal/`: WAL 로그 파일.
  - `pg_stat/`: 통계 정보 파일.

### 8.2. 데이터 파일 구조
- 데이터는 8KB 블록 단위로 관리됩니다.
- 데이터 파일은 테이블, 인덱스, 트랜잭션 로그 등 다양한 PostgreSQL 객체를 포함합니다.

---

## 9. 전체 저장 과정 요약

1. **클라이언트 요청**:
   - 클라이언트가 SQL 명령을 서버에 전송.
2. **SQL 처리**:
   - 파싱, 실행 계획 생성, 실행.
3. **WAL 기록**:
   - 변경 사항이 WAL에 기록.
4. **디스크 쓰기**:
   - 변경 사항이 데이터 파일로 저장.
5. **커밋 또는 롤백**:
   - 트랜잭션이 완료되거나 복구.

---

